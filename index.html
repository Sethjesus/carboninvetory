<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- =========================
       ğŸŒ¿ ESG ç¢³ç›¤æŸ¥ v5.9 ä¼æ¥­å¤šäººç‰ˆ
       - æœ¬æ©Ÿå„²å­˜ + JSON åŒ¯å…¥/åŒ¯å‡º
       - OneDrive å”ä½œ + æœ€å¾Œæ›´æ–°ç´€éŒ„
     ========================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ¿ ESG ç¢³ç›¤æŸ¥ v5.9 ä¼æ¥­å¤šäººç‰ˆ</title>

  <!-- ===== PWA ===== -->
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- ===== å¤–æ› ===== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- ===== æ¨£å¼ ===== -->
  <style>
    :root{
      --brand:#16a34a;
      --ink:#0f172a;
      --bg:#f8fafc;
      --panel:#ffffff;
      --shadow:0 10px 28px rgba(2,6,23,.08);
    }
    html,body{
      margin:0;
      padding:0;
      font-family:"Microsoft JhengHei",system-ui,Segoe UI,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }
    header{
      position:sticky;
      top:0;
      z-index:10;
      background:linear-gradient(180deg,#ffffff 0%,#ffffffcc 100%);
      backdrop-filter:saturate(140%) blur(4px);
      border-bottom:1px solid #e5e7eb;
    }
    .card{
      background:var(--panel);
      border-radius:1rem;
      box-shadow:var(--shadow);
      padding:1.25rem;
    }
    .btn{
      background:var(--brand);
      color:#fff;
      border-radius:.6rem;
      padding:.5rem .95rem;
      font-weight:700;
      cursor:pointer;
      border:none;
    }
    .btn-ghost{
      border:1px dashed #94a3b8;
      color:#334155;
      background:transparent;
      border-radius:.6rem;
      padding:.5rem .95rem;
      font-weight:700;
      cursor:pointer;
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{
      padding:.55rem .6rem;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    th{ background:#f1f5f9; font-weight:800; }
    .num{text-align:right;}
    input,select{
      width:100%;
      border:1px solid #e5e7eb;
      border-radius:.5rem;
      padding:.35rem .5rem;
    }
    #toast{
      position:fixed;
      right:24px;
      bottom:28px;
      background:var(--brand);
      color:#fff;
      font-weight:800;
      padding:.5rem .9rem;
      border-radius:.7rem;
      opacity:0;
      transform:translateY(16px);
      transition:.35s;
      z-index:9999;
    }
    #toast.show{
      opacity:1;
      transform:translateY(0);
    }
    .hint{ font-size:.85rem; color:#64748b; }
    .k{ color:#0ea5e9; font-weight:700; }

    /* ===== Login Overlay ===== */
    #loginOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.72);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:99999;
    }
    #loginCard{
      background:#ffffff;
      border-radius:1rem;
      box-shadow:0 20px 40px rgba(15,23,42,0.35);
      padding:1.75rem 2rem;
      width:320px;
      max-width:90vw;
    }
    #loginCard h2{ margin:0 0 .75rem; font-size:1.2rem; font-weight:800; }
    #loginCard label{ font-size:.9rem; font-weight:600; color:#475569; }
    #loginCard input{
      width:100%;
      border:1px solid #e2e8f0;
      border-radius:.5rem;
      padding:.4rem .6rem;
      margin-top:.15rem;
      margin-bottom:.6rem;
    }
    #loginError{
      font-size:.8rem;
      color:#ef4444;
      min-height:1em;
      margin-bottom:.4rem;
    }
  </style>
</head>

<body>
  <!-- ç™»å…¥é®ç½©ï¼ˆå¸³è™Ÿ 1234 / å¯†ç¢¼ 1234ï¼‰ -->
  <div id="loginOverlay">
    <div id="loginCard">
      <h2>ğŸ” ESG ç¢³ç›¤æŸ¥ç™»å…¥</h2>
      <p style="font-size:.85rem;color:#64748b;margin:0 0 .75rem;">
        è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼å¾Œé–‹å§‹ä½¿ç”¨ã€‚<br>
        ï¼ˆé è¨­ï¼šå¸³è™Ÿ <b>1234</b>ï¼Œå¯†ç¢¼ <b>1234</b>ï¼‰
      </p>
      <form id="loginForm">
        <label>å¸³è™Ÿ</label>
        <input id="loginUser" type="text" autocomplete="off" />
        <label>å¯†ç¢¼</label>
        <input id="loginPass" type="password" autocomplete="off" />
        <div id="loginError"></div>
        <button type="submit" class="btn" style="width:100%;margin-top:.25rem;">
          ç™»å…¥
        </button>
      </form>
    </div>
  </div>

  <!-- ===== Header ===== -->
  <header class="px-4">
    <div class="max-w-7xl mx-auto py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl">ğŸŒ¿</div>
        <div>
          <div class="text-xl font-extrabold leading-tight">ESG ç¢³ç›¤æŸ¥ v5.9 ä¼æ¥­å¤šäººç‰ˆ</div>
          <div class="text-xs text-slate-500">
            å›ºå®šï¼‹è‡ªå»ºï¼‹éƒ¨é–€ï¼‹Excel/PDFï¼‹æœ¬æ©Ÿ JSON åŒ¯å…¥/åŒ¯å‡ºï¼‹OneDrive å”ä½œï¼‹PWA
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="btn-ghost text-sm">ğŸŒ / ğŸŒ™</button>
      </div>
    </div>
  </header>

  <div id="toast">å·²å„²å­˜</div>

  <!-- éš±è—çš„æª”æ¡ˆé¸æ“‡å™¨ï¼ˆåŒ¯å…¥ JSON ç”¨ï¼‰ -->
  <input type="file" id="fileJSON" accept="application/json" style="display:none;" />

  <!-- ===== Main ===== -->
  <main class="max-w-7xl mx-auto px-4 pb-28">

    <!-- ä¼æ¥­è³‡è¨Š -->
    <section class="card mt-5">
      <div class="flex items-center justify-between mb-1">
        <h2 class="font-bold text-lg">ğŸ¢ ä¼æ¥­è³‡è¨Š</h2>
        <div id="metaInfo" class="text-xs text-slate-500 text-right">
          å°šæœªæœ‰é ç«¯å…±äº«ç´€éŒ„ã€‚
        </div>
      </div>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm mb-1">å…¬å¸åç¨±</label>
          <input id="companyName" type="text" value="æ™¯æ²› ESG" placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±" />
        </div>
        <div>
          <label class="block text-sm mb-1">å¹´åº¦ï¼ˆè¥¿å…ƒå¹´ï¼‰</label>
          <input id="fiscalYear" type="number" value="2025" min="2000" max="2100" step="1" />
        </div>
        <div>
          <label class="block text-sm mb-1">æ“ä½œäººå§“å</label>
          <input id="operatorName" type="text" value="" placeholder="ä¾‹å¦‚ï¼šJacky / å°ç¾" />
        </div>
        <div class="flex items-end gap-2">
          <button id="saveMeta" class="btn">å„²å­˜å…¬å¸/å¹´åº¦/æ“ä½œäºº</button>
          <span class="hint">å°‡ä»¥ <span class="k">å…¬å¸ï¼‹å¹´åº¦</span> ä½œç‚ºè³‡æ–™å‘½åç©ºé–“ã€‚</span>
        </div>
      </div>
    </section>

    <!-- æœˆä»½ -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">ğŸ“… æœˆä»½é¸æ“‡</h2>
      <div id="monthTabs" class="flex flex-wrap gap-2"></div>
      <div class="hint mt-2">
        åˆ‡æ›æœˆä»½å‰æœƒè‡ªå‹•å„²å­˜ã€‚ä¸Šæ¬¡ä½¿ç”¨çš„å…¬å¸ / å¹´åº¦ / æœˆä»½æœƒè‡ªå‹•å¸¶å…¥ã€‚
      </div>
    </section>

    <!-- å›ºå®šé …ç›® -->
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold text-lg">ğŸ“˜ å›ºå®šé …ç›®ï¼ˆè‡ªå‹•ç¯„ç–‡ï¼‹ä¿‚æ•¸ï¼‹éƒ¨é–€ï¼‰</h2>
        <div class="flex items-center gap-2">
          <button id="btnResetPreset" class="btn-ghost">â†» é‡ç½®é è¨­</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="tableFixed" class="text-sm">
          <thead>
            <tr>
              <th>é …ç›®</th>
              <th>ç¯„ç–‡</th>
              <th class="num">ç”¨é‡</th>
              <th>å–®ä½</th>
              <th class="num">æ’æ”¾ä¿‚æ•¸</th>
              <th>éƒ¨é–€ï¼æ“šé»</th>
              <th class="num">æ’æ”¾é‡ (kgCOâ‚‚e)</th>
            </tr>
          </thead>
          <tbody id="tbodyFixed"></tbody>
          <tfoot class="font-bold bg-slate-50">
            <tr>
              <td colspan="6" class="text-right">å›ºå®šåˆè¨ˆ</td>
              <td id="sumFixed" class="num">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="hint mt-2">å›ºå®šé …ç›®ï¼šåªéœ€è¼¸å…¥ã€Œç”¨é‡ã€èˆ‡ã€Œéƒ¨é–€ã€ï¼Œæœƒä¾ä¿‚æ•¸è‡ªå‹•ç®—æ’æ”¾ã€‚</div>
    </section>

    <!-- è‡ªå»ºé …ç›® -->
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-bold text-lg">âœï¸ è‡ªå»ºé …ç›®ï¼ˆæ‰‹å‹•è¼¸å…¥æ‰€æœ‰æ¬„ä½ï¼‰</h2>
        <div class="flex items-center gap-2">
          <button id="btnAddCustom" class="btn">+ æ–°å¢é …ç›®</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="tableCustom" class="text-sm">
          <thead>
            <tr>
              <th>é …ç›®</th>
              <th>åˆ†é¡</th>
              <th>ç¯„ç–‡</th>
              <th class="num">ç”¨é‡</th>
              <th>å–®ä½</th>
              <th class="num">æ’æ”¾ä¿‚æ•¸</th>
              <th>éƒ¨é–€ï¼æ“šé»</th>
              <th class="num">æ’æ”¾é‡</th>
              <th>åˆªé™¤</th>
            </tr>
          </thead>
          <tbody id="tbodyCustom"></tbody>
          <tfoot class="font-bold bg-slate-50">
            <tr>
              <td colspan="7" class="text-right">è‡ªå»ºåˆè¨ˆ</td>
              <td id="sumCustom" class="num">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- åŠŸèƒ½åˆ—ï¼ˆå« OneDrive èªªæ˜ï¼‰ -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">ğŸ’¾ åŠŸèƒ½åˆ—ï¼ˆå¤šäººå…±ç”¨ + OneDriveï¼‰</h2>
      <div class="flex flex-wrap gap-3">
        <button id="btnCalc" class="btn">é‡æ–°è¨ˆç®—</button>
        <button id="btnExportExcel" class="btn-ghost">åŒ¯å‡º Excelï¼ˆå›ºå®šï¼‹è‡ªå»ºï¼‰</button>
        <button id="btnExportPDF" class="btn-ghost">åŒ¯å‡º PDFï¼ˆå« 3 åœ–ï¼‰</button>
        <button id="btnDownloadJSON" class="btn-ghost">ğŸ’¾ ä¸€éµå­˜æª”ï¼ˆä¸‹è¼‰å…±äº«æª”ï¼‰</button>
        <button id="btnImportJSON" class="btn-ghost">ğŸ“‚ å¾å…±äº«æª”æ¡ˆåŒ¯å…¥</button>

        <!-- ğŸ”— ç›´æ¥é–‹å•Ÿä½ çš„ OneDrive å…±äº«è³‡æ–™å¤¾ -->
        <a href="https://1drv.ms/f/c/8ef63fdd92f9370f/EniPxLP34YdPi-MJWpVuOQwBl9nH9ZNRfLkuiQRXYNhTzw?e=1PS5ox" 
           target="_blank"
           class="btn-ghost"
           style="text-decoration:none; display:flex; align-items:center;">
           ğŸ”— æ‰“é–‹ OneDrive å…±ç”¨è³‡æ–™å¤¾
        </a>
      </div>

      <div class="hint mt-2">
        âœ… <b>å¤šäººå”ä½œï¼ˆå»ºè­°æµç¨‹ï¼‰</b><br>
        1ï¸âƒ£ ä»»ä¸€å°é›»è…¦å¡«å®Œå¾ŒæŒ‰ã€Œ<b>ğŸ’¾ ä¸€éµå­˜æª”</b>ã€â†’ æœƒä¸‹è¼‰ <span class="k">å…¬å¸_å¹´åº¦.json</span>ï¼ˆä¾‹å¦‚ï¼šæ™¯æ²›ESG_2025.jsonï¼‰ã€‚<br>
        2ï¸âƒ£ å°‡æ­¤æª”æ¡ˆæ”¾åˆ°å…¬å¸ OneDrive å…±äº«è³‡æ–™å¤¾ï¼š<br>
        &nbsp;&nbsp;&nbsp;&nbsp;<a href="https://1drv.ms/f/c/8ef63fdd92f9370f/EniPxLP34YdPi-MJWpVuOQwBl9nH9ZNRfLkuiQRXYNhTzw?e=1PS5ox" 
           target="_blank" style="color:#0ea5e9;">ğŸ‘‰ é»æˆ‘é–‹å•Ÿ ESG å…±ç”¨è³‡æ–™å¤¾</a><br>
        3ï¸âƒ£ å…¶ä»–é›»è…¦è¦ç·¨è¼¯æ™‚ï¼š<br>
        &nbsp;&nbsp;â€¢ è‹¥æœ‰ OneDrive åŒæ­¥ç¨‹å¼ â†’ åŒ¯å…¥æ™‚ç›´æ¥å¾ OneDrive è³‡æ–™å¤¾é¸é€™å€‹ JSON æª”ã€‚<br>
        &nbsp;&nbsp;â€¢ è‹¥åªæœ‰ OneDrive ç¶²é  â†’ è«‹å…ˆå¾ OneDrive ä¸‹è¼‰ JSON æª”åˆ°æœ¬æ©Ÿï¼Œå†æŒ‰ã€ŒğŸ“‚ å¾å…±äº«æª”æ¡ˆåŒ¯å…¥ã€é¸æª”ã€‚<br>
        4ï¸âƒ£ ä¿®æ”¹å®Œæˆå¾Œï¼Œå†æŒ‰ä¸€æ¬¡ã€ŒğŸ’¾ ä¸€éµå­˜æª”ã€ï¼Œä¸¦ç”¨æ–°æª”æ¡ˆè¦†è“‹ OneDrive ä¸­çš„èˆŠæª”ã€‚<br><br>
        ğŸ” å»ºè­°å…¨å…¬å¸ä½¿ç”¨ã€ŒåŒä¸€å€‹å›ºå®šæª”åã€ï¼Œä¾‹å¦‚ï¼š<span class="k">æ™¯æ²›ESG_2025.json</span>ï¼Œé¿å…ç‰ˆæœ¬æ··äº‚ã€‚<br>
        â„¹ æ­¤ç³»çµ±æœƒåœ¨ JSON è£¡åŠ å…¥ <span class="k">_meta</span> æ¬„ä½ï¼Œè¨˜éŒ„å…¬å¸ã€å¹´åº¦ã€æ“ä½œäººã€æœ€å¾Œæ›´æ–°æ™‚é–“ã€‚
      </div>
    </section>

    <!-- åœ–è¡¨ -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">ğŸ“Š è¦–è¦ºåŒ–åˆ†æ</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <h3 class="font-semibold mb-1">å„é …ç›®æ’æ”¾é‡</h3>
          <canvas id="chartItems"></canvas>
        </div>
        <div>
          <h3 class="font-semibold mb-1">S1/S2/S3 æ¯”ä¾‹</h3>
          <canvas id="chartScopes"></canvas>
        </div>
        <div>
          <h3 class="font-semibold mb-1">å›ºå®š vs è‡ªå»º</h3>
          <canvas id="chartTrend"></canvas>
        </div>
      </div>
    </section>

    <!-- ä¸»ç¨‹å¼èªªæ˜ -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">âš™ï¸ ç¨‹å¼ç¢¼ï¼ˆå…§åµŒï¼‰</h2>
      <pre class="text-xs whitespace-pre-wrap leading-5 text-slate-600">
æœ¬é å·²å…§åµŒå®Œæ•´ JSï¼š
- ç™»å…¥ï¼ˆ1234/1234ï¼‰
- localStorage è‡ªå‹•è¨˜éŒ„ï¼ˆå«å…¬å¸ / å¹´åº¦ / æœˆä»½ï¼‰
- _metaï¼šå…¬å¸ / å¹´åº¦ / æ“ä½œäºº / æœ€å¾Œæ›´æ–°æ™‚é–“
- æœ¬æ©Ÿ JSON ä¸€éµå­˜æª” / åŒ¯å…¥ï¼ˆæ­é… OneDriveï¼‰
- Excel / PDF / åœ–è¡¨è¼¸å‡º
      </pre>
    </section>

    <script>
      /* =========================
         ç°¡æ˜“ç™»å…¥ï¼ˆå¸³è™Ÿ/å¯†ç¢¼ 1234ï¼‰â†’ æ¯æ¬¡éƒ½è¦ç™»å…¥
      ========================= */
      const LOGIN_USER = "1234";
      const LOGIN_PASS = "1234";

      // è¨˜éŒ„ä¸Šæ¬¡å…¬å¸ / å¹´åº¦ / æœˆä»½
      const META_KEY = "ESGv59_meta";

      const loginOverlay = document.getElementById("loginOverlay");
      const loginForm    = document.getElementById("loginForm");
      const loginUser    = document.getElementById("loginUser");
      const loginPass    = document.getElementById("loginPass");
      const loginError   = document.getElementById("loginError");

      function checkLogin() {
        loginOverlay.style.display = "flex";
        loginOverlay.style.opacity = "1";
        loginUser.focus();
      }

      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const u = (loginUser.value || "").trim();
        const p = (loginPass.value || "").trim();
        if (u === LOGIN_USER && p === LOGIN_PASS) {
          loginError.textContent = "";
          loginOverlay.style.transition = "opacity .25s";
          loginOverlay.style.opacity = "0";
          setTimeout(() => {
            loginOverlay.style.display = "none";
          }, 260);
        } else {
          loginError.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        }
      });

      checkLogin();

      /* =========================
         ä¸»é¡Œåˆ‡æ›ï¼ˆlight/darkï¼‰
      ========================= */
      const themeToggle = document.getElementById("themeToggle");
      function applyTheme(mode) {
        document.documentElement.classList.toggle("dark", mode === "dark");
        localStorage.setItem("carbonTheme", mode);
      }
      themeToggle.onclick = () => {
        const isDark = document.documentElement.classList.contains("dark");
        applyTheme(isDark ? "light" : "dark");
      };
      applyTheme(localStorage.getItem("carbonTheme") || "light");

      /* =========================
         DOM + ç‹€æ…‹
      ========================= */
      const tbodyFixed  = document.getElementById("tbodyFixed");
      const tbodyCustom = document.getElementById("tbodyCustom");
      const sumFixed    = document.getElementById("sumFixed");
      const sumCustom   = document.getElementById("sumCustom");
      const toast       = document.getElementById("toast");
      const fileJSON    = document.getElementById("fileJSON");
      const metaInfo    = document.getElementById("metaInfo");

      let store = {};                               // { _meta:{...}, 1..12: { fixed:{...}, custom:[...] } }
      let currentMonth = new Date().getMonth() + 1; // 1~12

      /* =========================
         å›ºå®šé …ç›®ï¼šé è¨­ï¼ˆå«éƒ¨é–€ï¼‰
      ========================= */
      const FIXED_ITEMS = [
        { name:"é›»åŠ›",       scope:"S2", unit:"kWh", factor:0.495, dept:"ç¸½éƒ¨"   },
        { name:"è‡ªä¾†æ°´",     scope:"S2", unit:"mÂ³",  factor:0.156, dept:"ç¸½éƒ¨"   },
        { name:"æ±½æ²¹",       scope:"S1", unit:"L",   factor:2.92,  dept:"ç‰©æµ"   },
        { name:"æŸ´æ²¹",       scope:"S1", unit:"L",   factor:3.32,  dept:"ç‰©æµ"   },
        { name:"å¤©ç„¶æ°£",     scope:"S1", unit:"mÂ³",  factor:2.63,  dept:"é¤é£²éƒ¨" },
        { name:"äº¤é€šé€šå‹¤",   scope:"S3", unit:"km",  factor:0.251, dept:"æ¥­å‹™éƒ¨" },
        { name:"åƒåœ¾ç„šåŒ–",   scope:"S3", unit:"kg",  factor:1.01,  dept:"æ¸…æ½”"   },
        { name:"é¤é£²è†³é£Ÿ",   scope:"S3", unit:"ä»½",  factor:1.29,  dept:"é¤é£²éƒ¨" },
        { name:"ç´™å¼µä½¿ç”¨",   scope:"S3", unit:"kg",  factor:0.402, dept:"è¡Œæ”¿"   },
        { name:"å»¢æ°´è™•ç†",   scope:"S3", unit:"mÂ³",  factor:0.533, dept:"æ¸…æ½”"   }
      ];

      /* =========================
         å°å·¥å…·
      ========================= */
      const showToast = (msg) => {
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 1400);
      };
      const safeKey = (s) => (s || "å…¬å¸").replace(/[\\\/:*?"<>|.\s]+/g, "_");

      function getMeta(){
        const company  = (document.getElementById("companyName").value || "å…¬å¸").trim();
        const year     = parseInt(document.getElementById("fiscalYear").value) || new Date().getFullYear();
        const operator = (document.getElementById("operatorName").value || "").trim();
        return { company, year, operator };
      }
      function localKey(){
        const m = getMeta();
        return `ESGv59__${safeKey(m.company)}__${m.year}`;
      }

      // è¨˜éŒ„æœ€å¾Œä¸€æ¬¡ä½¿ç”¨çš„å…¬å¸ / å¹´åº¦ / æœˆä»½
      function saveMetaOnly(){
        const { company, year, operator } = getMeta();
        const meta = { company, year, month: currentMonth, operator };
        localStorage.setItem(META_KEY, JSON.stringify(meta));
      }

      function updateMetaInfo(){
        if(!metaInfo) return;
        const m = store._meta;
        if(!m || !m.lastUpdated){
          metaInfo.textContent = "å°šæœªæœ‰é ç«¯å…±äº«ç´€éŒ„ã€‚";
          return;
        }
        let txt = "";
        try{
          const d = new Date(m.lastUpdated);
          if(!isNaN(d.getTime())){
            const y = d.getFullYear();
            const mo = String(d.getMonth()+1).padStart(2,"0");
            const da = String(d.getDate()).padStart(2,"0");
            const hh = String(d.getHours()).padStart(2,"0");
            const mm = String(d.getMinutes()).padStart(2,"0");
            txt = `æœ€å¾Œæ›´æ–°ï¼š${y}-${mo}-${da} ${hh}:${mm}ï¼ˆæ“ä½œäººï¼š${m.operator||"æœªå¡«"}ï¼‰`;
          }else{
            txt = `æœ€å¾Œæ›´æ–°ï¼š${m.lastUpdated}ï¼ˆæ“ä½œäººï¼š${m.operator||"æœªå¡«"}ï¼‰`;
          }
        }catch(e){
          txt = `æœ€å¾Œæ›´æ–°ï¼š${m.lastUpdated}ï¼ˆæ“ä½œäººï¼š${m.operator||"æœªå¡«"}ï¼‰`;
        }
        metaInfo.textContent = txt;
      }

      /* =========================
         æœˆä»½ UI
      ========================= */
      function buildMonthTabs(){
        const host = document.getElementById("monthTabs");
        host.innerHTML = "";
        for(let m=1;m<=12;m++){
          const b = document.createElement("button");
          b.textContent = m + "æœˆ";
          b.className = "btn-ghost " + (m===currentMonth ? "bg-green-100" : "");
          b.onclick = () => {
            saveLocal(false);   // åˆ‡æ›å‰å…ˆå­˜
            currentMonth = m;
            saveMetaOnly();     // åŒæ­¥è¨˜éŒ„æœ€å¾Œä½¿ç”¨æœˆä»½
            renderAll();
          };
          host.appendChild(b);
        }
      }

      /* =========================
         å›ºå®šè¡¨ï¼šæ¸²æŸ“
      ========================= */
      function renderFixed(){
        tbodyFixed.innerHTML = "";
        const fixedState = (store[currentMonth] && store[currentMonth].fixed) ? store[currentMonth].fixed : {};

        FIXED_ITEMS.forEach((it, idx) => {
          const act  = (fixedState[idx] && fixedState[idx].activity != null) ? fixedState[idx].activity : 0;
          const dept = (fixedState[idx] && fixedState[idx].dept) ? fixedState[idx].dept : it.dept;
          const emi  = (parseFloat(act)||0) * it.factor;

          const tr = document.createElement("tr");
          tr.innerHTML = [
            `<td>${it.name}</td>`,
            `<td>${it.scope}</td>`,
            `<td><input type="number" class="num actFixed" data-idx="${idx}" value="${act}" min="0" step="0.001"></td>`,
            `<td>${it.unit}</td>`,
            `<td class="num">${it.factor}</td>`,
            `<td><input value="${dept}" placeholder="éƒ¨é–€ï¼æ“šé»"></td>`,
            `<td class="num emiFixed">${emi.toFixed(3)}</td>`
          ].join("");

          tbodyFixed.appendChild(tr);
        });

        calcFixed();
      }

      /* =========================
         è‡ªå»ºè¡¨ï¼šæ¸²æŸ“ & è¡Œç”¢ç”Ÿå™¨
      ========================= */
      function trCustomRow(o={}){
        const s = o.scope || "S3";
        const act = o.activity || 0;
        const fac = o.factor || 0;
        const emi = (parseFloat(act)||0) * (parseFloat(fac)||0);

        const tr = document.createElement("tr");
        tr.innerHTML = [
          `<td><input value="${o.name||""}" placeholder="é …ç›®"></td>`,
          `<td><input value="${o.category||""}" placeholder="åˆ†é¡"></td>`,
          `<td>
            <select>
              <option value="S1" ${s==="S1"?"selected":""}>S1</option>
              <option value="S2" ${s==="S2"?"selected":""}>S2</option>
              <option value="S3" ${s==="S3"?"selected":""}>S3</option>
            </select>
          </td>`,
          `<td><input type="number" class="num" value="${act}" min="0" step="0.001"></td>`,
          `<td><input value="${o.unit||""}" placeholder="å–®ä½"></td>`,
          `<td><input type="number" class="num" value="${fac}" step="0.001"></td>`,
          `<td><input value="${o.dept||"æœªå¡«"}" placeholder="éƒ¨é–€ï¼æ“šé»"></td>`,
          `<td class="num emi">${emi.toFixed(3)}</td>`,
          `<td><button class="text-red-500 del">åˆªé™¤</button></td>`
        ].join("");

        return tr;
      }

      function renderCustom(){
        tbodyCustom.innerHTML = "";
        const list = (store[currentMonth] && store[currentMonth].custom) ? store[currentMonth].custom : [];
        list.forEach(rowObj => tbodyCustom.appendChild(trCustomRow(rowObj)));
        calcCustom();
      }

      /* =========================
         è¨ˆç®—ï¼šå›ºå®š / è‡ªå»º
      ========================= */
      function calcFixed(){
        let total = 0;
        const trs = [...tbodyFixed.querySelectorAll("tr")];

        trs.forEach((tr, idx) => {
          const act  = parseFloat(tr.querySelector(".actFixed").value) || 0;
          const dept = tr.children[5].querySelector("input").value || FIXED_ITEMS[idx].dept;
          const emi  = act * FIXED_ITEMS[idx].factor;
          tr.querySelector(".emiFixed").textContent = emi.toFixed(3);
          total += emi;

          if(!store[currentMonth]) store[currentMonth] = {};
          if(!store[currentMonth].fixed) store[currentMonth].fixed = {};
          store[currentMonth].fixed[idx] = { activity: act, dept };
        });

        sumFixed.textContent = total.toFixed(3);
        saveLocal(false);
        drawCharts();
      }

      function calcCustom(){
        let total = 0;
        const trs = [...tbodyCustom.querySelectorAll("tr")];

        trs.forEach(tr => {
          const t  = tr.querySelectorAll("input,select");
          const a  = parseFloat(t[3].value) || 0;   // ç”¨é‡
          const f  = parseFloat(t[5].value) || 0;   // ä¿‚æ•¸
          const emi = a * f;
          tr.querySelector(".emi").textContent = emi.toFixed(3);
          total += emi;
        });

        sumCustom.textContent = total.toFixed(3);
        saveLocal(false);
        drawCharts();
      }

      tbodyFixed .addEventListener("input", calcFixed);
      tbodyCustom.addEventListener("input",  calcCustom);
      tbodyCustom.addEventListener("click", (e) => {
        if(e.target.classList.contains("del")){
          e.target.closest("tr").remove();
          calcCustom();
        }
      });
      document.getElementById("btnAddCustom").onclick = () => {
        tbodyCustom.appendChild(trCustomRow());
      };

      /* =========================
         å„²å­˜ / è¼‰å…¥ï¼ˆlocalStorageï¼‰
      ========================= */
      function packCustomRows(){
        return [...tbodyCustom.querySelectorAll("tr")].map(tr => {
          const t = tr.querySelectorAll("input,select");
          return {
            name:t[0].value,
            category:t[1].value,
            scope:t[2].value,
            activity:parseFloat(t[3].value)||0,
            unit:t[4].value,
            factor:parseFloat(t[5].value)||0,
            dept:t[6].value
          };
        });
      }

      function saveLocal(showToastNow=true){
        if(!store[currentMonth]) store[currentMonth] = {};
        store[currentMonth].custom = packCustomRows();

        // meta å¯«é€² store._metaï¼Œæœƒä¸€èµ·è¢«å­˜åˆ° JSON
        const { company, year, operator } = getMeta();
        const lastUpdated = new Date().toISOString();
        store._meta = { company, year, operator: operator || "æœªå¡«", lastUpdated };

        localStorage.setItem(localKey(), JSON.stringify(store));
        saveMetaOnly();
        updateMetaInfo();

        if(showToastNow) showToast("å·²å„²å­˜");
      }

      function loadLocal(){
        store = JSON.parse(localStorage.getItem(localKey()) || "{}");
        if(!store || typeof store !== "object") store = {};
      }

      document.getElementById("saveMeta").onclick = () => {
        saveMetaOnly();
        saveLocal(true);
      };

      document.getElementById("btnResetPreset").onclick = () => {
        if(confirm("ç¢ºå®šè¦é‡ç½®æœ¬æœˆå›ºå®šé …ç›®ï¼Ÿï¼ˆåƒ…æ¸…é™¤ç”¨é‡èˆ‡éƒ¨é–€å›é è¨­ï¼‰")){
          if(!store[currentMonth]) store[currentMonth] = {};
          store[currentMonth].fixed = {};
          FIXED_ITEMS.forEach((f, i) => { store[currentMonth].fixed[i] = { activity:0, dept:f.dept }; });
          renderFixed();
          saveLocal(true);
        }
      };

      document.getElementById("btnCalc").onclick = () => { calcFixed(); calcCustom(); };

      /* =========================
         JSON åŒ¯å‡º / åŒ¯å…¥ï¼ˆæœ¬æ©Ÿ + OneDrive æ‰‹å‹•æ¬æª”ï¼‰
      ========================= */

      // ä¸€éµå­˜æª”ï¼šæŠŠç›®å‰å…¬å¸ï¼‹å¹´åº¦çš„ store ä¸‹è¼‰æˆ JSON æª”
      document.getElementById("btnDownloadJSON").onclick = () => {
        // å…ˆç¢ºä¿ç•«é¢ç‹€æ…‹å¯«å› store / localStorage
        saveLocal(false);

        const { company, year } = getMeta();
        const key   = localKey();
        const data  = localStorage.getItem(key) || "{}";

        const blob = new Blob([data], { type: "application/json;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${safeKey(company)}_${year}.json`;
        a.click();
        URL.revokeObjectURL(a.href);

        showToast("JSON å·²å­˜æª”ï¼ˆå¯æ”¾å…¥ OneDrive æˆ–çµ¦åŒäº‹åŒ¯å…¥ï¼‰");
      };

      // åŒ¯å…¥ JSONï¼šå¾æœ¬æ©Ÿé¸æª” â†’ è¦†è“‹ç›®å‰å…¬å¸ï¼‹å¹´åº¦çš„ store
      document.getElementById("btnImportJSON").onclick = () => {
        fileJSON.value = "";   // reset input
        fileJSON.click();
      };

      fileJSON.addEventListener("change", () => {
        const file = fileJSON.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const text = reader.result || "{}";
            const obj  = JSON.parse(text);

            // ç›´æ¥å­˜åˆ°ç›®å‰å…¬å¸ï¼‹å¹´åº¦çš„ key
            localStorage.setItem(localKey(), JSON.stringify(obj));

            // é‡æ–°è¼‰å…¥ & æ¸²æŸ“
            loadLocal();
            renderAll();
            showToast("å·²å¾ JSON åŒ¯å…¥è³‡æ–™");
          }catch(e){
            alert("JSON è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
          }
        };
        reader.readAsText(file, "utf-8");
      });

      /* =========================
         Excel / PDF
      ========================= */
      document.getElementById("btnExportExcel").onclick = () => {
        const { company, year } = getMeta();
        const wb = XLSX.utils.book_new();

        const headerFixed = ["é …ç›®","ç¯„ç–‡","ç”¨é‡","å–®ä½","æ’æ”¾ä¿‚æ•¸","éƒ¨é–€","æ’æ”¾é‡"];
        const dataFixed = [ ["å…¬å¸åç¨±",company], ["å¹´åº¦",year], [], headerFixed ];
        [...tbodyFixed.querySelectorAll("tr")].forEach((tr, idx) => {
          const act = parseFloat(tr.querySelector(".actFixed").value)||0;
          const d   = tr.children[5].querySelector("input").value || FIXED_ITEMS[idx].dept;
          const f   = FIXED_ITEMS[idx];
          dataFixed.push([ f.name, f.scope, act, f.unit, f.factor, d, (act*f.factor).toFixed(3) ]);
        });
        const wsFixed = XLSX.utils.aoa_to_sheet(dataFixed);
        XLSX.utils.book_append_sheet(wb, wsFixed, "å›ºå®šé …ç›®");

        const headerCustom = ["é …ç›®","åˆ†é¡","ç¯„ç–‡","ç”¨é‡","å–®ä½","æ’æ”¾ä¿‚æ•¸","éƒ¨é–€","æ’æ”¾é‡"];
        const dataCustom = [ ["å…¬å¸åç¨±",company], ["å¹´åº¦",year], [], headerCustom ];
        [...tbodyCustom.querySelectorAll("tr")].forEach(tr => {
          const t = tr.querySelectorAll("input,select");
          const a = parseFloat(t[3].value)||0, f = parseFloat(t[5].value)||0;
          dataCustom.push([ t[0].value, t[1].value, t[2].value, a, t[4].value, f, t[6].value, (a*f).toFixed(3) ]);
        });
        const wsCustom = XLSX.utils.aoa_to_sheet(dataCustom);
        XLSX.utils.book_append_sheet(wb, wsCustom, "è‡ªå»ºé …ç›®");

        XLSX.writeFile(wb, `${safeKey(company)}_${year}_${currentMonth}æœˆ.xlsx`);
      };

      document.getElementById("btnExportPDF").onclick = async () => {
        try{
          const { PDFDocument } = PDFLib;
          const pdf = await PDFDocument.create();
          const page = pdf.addPage([842,595]); // A4 æ©«å¼

          const { company, year } = getMeta();
          const total = (parseFloat(sumFixed.textContent)||0) + (parseFloat(sumCustom.textContent)||0);

          const c = document.createElement("canvas");
          c.width = 800; c.height = 56;
          const ctx = c.getContext("2d");
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0,0,800,56);
          ctx.fillStyle = "#0f172a";
          ctx.font = 'bold 18px "Microsoft JhengHei", Arial, sans-serif';
          ctx.fillText(`${company} ç¢³ç›¤æŸ¥å ±è¡¨ï½œ${year} å¹´ ${currentMonth} æœˆï½œç¸½æ’æ”¾ï¼š${total.toFixed(3)} kgCOâ‚‚e`, 12, 35);
          const timg = await pdf.embedPng(c.toDataURL("image/png"));
          page.drawImage(timg, { x:21, y:520, width:800, height:56 });

          const chartNodes = [
            document.getElementById("chartItems"),
            document.getElementById("chartScopes"),
            document.getElementById("chartTrend")
          ];
          let x = 40, y = 305;
          for(const cn of chartNodes){
            const png = await pdf.embedPng(cn.toDataURL("image/png"));
            page.drawImage(png, { x, y, width:240, height:180 });
            x += 260;
          }

          const bytes = await pdf.save();
          const a = document.createElement("a");
          a.href = URL.createObjectURL(new Blob([bytes], { type:"application/pdf" }));
          a.download = `${safeKey(company)}_${year}_${currentMonth}.pdf`;
          a.click();
        }catch(err){
          alert("PDF ç”¢å‡ºéŒ¯èª¤ï¼š " + err.message);
        }
      };

      /* =========================
         åœ–è¡¨
      ========================= */
      let chartItems = null;
      let chartScopes = null;
      let chartTrend = null;

      function drawCharts(){
        const fixedEmis = [...tbodyFixed.querySelectorAll(".actFixed")].map((el,i)=>{
          const a = parseFloat(el.value) || 0;
          return a * FIXED_ITEMS[i].factor;
        });
        const customTotal = parseFloat(sumCustom.textContent) || 0;
        const labelsItems = [...FIXED_ITEMS.map(f=>f.name), "è‡ªå»ºåˆè¨ˆ"];
        const emisItems   = [...fixedEmis, customTotal];

        if(chartItems) chartItems.destroy();
        chartItems = new Chart(document.getElementById("chartItems"),{
          type:"bar",
          data:{
            labels: labelsItems,
            datasets:[{ label:"kgCOâ‚‚e", data: emisItems }]
          },
          options:{
            responsive:true,
            plugins:{ legend:{ display:false } }
          }
        });

        const acc = { S1:0, S2:0, S3:0 };

        FIXED_ITEMS.forEach((f,i) => {
          const a = parseFloat(tbodyFixed.querySelectorAll(".actFixed")[i].value) || 0;
          acc[f.scope] += a * f.factor;
        });

        [...tbodyCustom.querySelectorAll("tr")].forEach(tr => {
          const t = tr.querySelectorAll("input,select");
          const scope = t[2].value || "S3";
          const a = parseFloat(t[3].value) || 0;
          const f = parseFloat(t[5].value) || 0;
          acc[scope] += a * f;
        });

        if(chartScopes) chartScopes.destroy();
        chartScopes = new Chart(document.getElementById("chartScopes"),{
          type:"pie",
          data:{
            labels:Object.keys(acc),
            datasets:[{ data:Object.values(acc) }]
          },
          options:{ responsive:true }
        });

        const fixedTotal = parseFloat(sumFixed.textContent) || 0;
        if(chartTrend) chartTrend.destroy();
        chartTrend = new Chart(document.getElementById("chartTrend"),{
          type:"line",
          data:{
            labels:["å›ºå®š","è‡ªå»º"],
            datasets:[{ label:"kgCOâ‚‚e", data:[fixedTotal, customTotal] }]
          },
          options:{
            responsive:true,
            plugins:{ legend:{ display:false } }
          }
        });
      }

      /* =========================
         åˆå§‹åŒ–
      ========================= */

      function restoreMeta(){
        const raw = localStorage.getItem(META_KEY);
        if(!raw) return;
        try{
          const meta = JSON.parse(raw);
          if(meta.company) document.getElementById("companyName").value = meta.company;
          if(meta.year)    document.getElementById("fiscalYear").value  = meta.year;
          if(meta.operator)document.getElementById("operatorName").value= meta.operator;
          if(meta.month)   currentMonth = meta.month;
        }catch(e){}
      }

      function renderAll(){
        loadLocal();
        if(!store[currentMonth]) store[currentMonth] = {};
        if(!store[currentMonth].fixed){
          store[currentMonth].fixed = {};
          FIXED_ITEMS.forEach((f,i) => store[currentMonth].fixed[i] = { activity:0, dept:f.dept });
        }
        if(!store[currentMonth].custom) store[currentMonth].custom = [];
        renderFixed();
        renderCustom();
        buildMonthTabs();
        updateMetaInfo();
        drawCharts();
      }

      restoreMeta();
      renderAll();

      // PWA SW è¨»å†Š
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('service-worker.js').catch(()=>{});
      }
    </script>
  </main>
</body>
</html>
